<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Ticket</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
        #ticketData { margin: 20px; font-size: 1.2em; }
        #qrCodeContainer { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>Your Ticket</h1>
    <div id="ticketData">
        <p><strong>Name:</strong> <span id="ticketName"></span></p>
        <p><strong>Phone:</strong> <span id="ticketPhone"></span></p>
    </div>
    <div id="qrCodeContainer"></div>

    <script src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
    <script>
        async function decryptData(encryptedData, key) {
            const decoder = new TextDecoder();
            const encryptedArray = Uint8Array.from(atob(encryptedData), c => c.charCodeAt(0));

            const decrypted = await crypto.subtle.decrypt(
                { name: "AES-GCM", iv: new Uint8Array(12) },
                key,
                encryptedArray
            );

            return decoder.decode(decrypted);
        }

        async function importKey(exportedKey) {
            const keyData = Uint8Array.from(atob(exportedKey), c => c.charCodeAt(0));
            return await crypto.subtle.importKey(
                "raw",
                keyData,
                { name: "AES-GCM", length: 256 },
                true,
                ["encrypt", "decrypt"]
            );
        }

        const urlParams = new URLSearchParams(window.location.search);
        const encryptedData = decodeURIComponent(urlParams.get("data") || "");
        const exportedKey = decodeURIComponent(urlParams.get("key") || "");

        if (encryptedData && exportedKey) {
            (async () => {
                const key = await importKey(exportedKey);
                const decryptedData = await decryptData(encryptedData, key);

                const { name, phone } = JSON.parse(decryptedData);

                document.getElementById("ticketName").textContent = name;
                document.getElementById("ticketPhone").textContent = phone;

                const ticketUrl = window.location.href;
                const qrCode = new QRCodeStyling({
                    width: 400,
                    height: 400,
                    data: ticketUrl,
                    image: "download.png",
                    dotsOptions: {
                        color: "#28a745",
                        type: "square"
                    },
                    backgroundOptions: {
                        color: "#ffffff"
                    },
                    imageOptions: {
                        crossOrigin: "anonymous",
                        margin: 10,
                        imageSize: 0.4
                    }
                });

                qrCode.append(document.getElementById("qrCodeContainer"));
            })();
        } else {
            console.error("Encrypted data or key is missing.");
        }
    </script>
</body>
</html>
